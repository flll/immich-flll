#
# Immich OCI Archive Storage 暗号化バックアップ - Docker Compose設定
#
# このファイルはバックアップスクリプトを実行するための
# Docker Compose設定です。
#
# 使用方法:
#   docker compose run --rm oci-backup    # フォアグラウンドで実行（推奨）
#   docker compose logs -f                # ログをリアルタイムで確認
#
# 注意: パスコード入力が必要なため、バックグラウンド実行(-d)は推奨しません
#

services:
  oci-backup:
    image: ghcr.io/oracle/oci-cli:20251029@sha256:ee374e857a438a7a1a4524c1398a6c43ed097c8f5b1e9a0e1ca05b7d01896eb6
    container_name: immich_oci_backup
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - "8181:8181"
    stdin_open: true
    tty: true
    command: /bin/bash /scripts/backup.sh
    volumes:
      - ./backup.sh:/scripts/backup.sh:ro
      - ./oci:/oracle/.oci
      - /mnt/hdd_blue/immich-app:/mnt/hdd_blue/immich-app:ro
    environment:
      - OCI_REGION=${OCI_REGION:-us-ashburn-1}
      - OCI_BUCKET_NAME=${OCI_BUCKET_NAME:-immich-backup}
      - OCI_COMPARTMENT_ID=${OCI_COMPARTMENT_ID:-}
      - OCI_NAMESPACE=${OCI_NAMESPACE:-}
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    restart: "no"
